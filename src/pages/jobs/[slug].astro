---
import BaseLayout from '../../layouts/BaseLayout.astro';
import jobsData from '../../data/jobs.json';
import '../../styles/job-detail.css';

export async function getStaticPaths() {
  return jobsData.map((job) => ({
    params: { slug: job.id },
    props: { job },
  }));
}

const { job } = Astro.props;

if (!job) {
  return Astro.redirect('/careers');
}
---

<BaseLayout title={`${job.title} | Buhl Engineering`} logoImage="/assets/images/Buhl Careers.png">
  <section class="hero">
    <div class="hero-tag">{job.type}</div>
    <h1>{job.title}</h1>
    <p class="hero-subtitle">{job.description}</p>
    <div class="job-meta-hero">
      <span class="meta-item">
        <svg class="meta-icon" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
        </svg>
        {job.location}
      </span>
      <span class="meta-item">
        <svg class="meta-icon" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
        </svg>
        {job.type}
      </span>
      <span class="meta-item">
        <svg class="meta-icon" fill="currentColor" viewBox="0 0 20 20">
          <path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3zM3.31 9.397L5 10.12v4.102a8.969 8.969 0 00-1.05-.174 1 1 0 01-.89-.89 11.115 11.115 0 01.25-3.762zM9.3 16.573A9.026 9.026 0 007 14.935v-3.957l1.818.78a3 3 0 002.364 0l5.508-2.361a11.026 11.026 0 01.25 3.762 1 1 0 01-.89.89 8.968 8.968 0 00-5.35 2.524 1 1 0 01-1.4 0zM6 18a1 1 0 001-1v-2.065a8.935 8.935 0 00-2-.712V17a1 1 0 001 1z"></path>
        </svg>
        {job.type} Program
      </span>
    </div>
    <button type="button" class="apply-btn" id="applyBtn">
      Apply Now
      <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd"></path>
      </svg>
    </button>
  </section>

  <main class="container">
    <section class="section">
      <h2 class="section-title">About the Role</h2>
      <div class="section-content">
        <p>{job.fullDescription}</p>
      </div>
    </section>

    <section class="section">
      <h2 class="section-title">What You'll Do</h2>
      <div class="requirements-list">
        {job.responsibilities.map((responsibility) => (
          <div class="requirement-item">{responsibility}</div>
        ))}
      </div>
    </section>

    <section class="section">
      <h2 class="section-title">What We're Looking For</h2>
      <div class="requirements-list">
        {job.requirements.map((requirement) => (
          <div class="requirement-item">{requirement}</div>
        ))}
      </div>
    </section>

    <section class="section">
      <h2 class="section-title">What We Offer</h2>
      <div class="requirements-list">
        {job.benefits.map((benefit) => (
          <div class="requirement-item">{benefit}</div>
        ))}
      </div>
    </section>

    <section class="section">
      <h2 class="section-title">Compensation</h2>
      <div class="section-content">
        <p>{job.salaryRange}</p>
      </div>
    </section>
  </main>

  <script is:inline define:vars={{ tallyFormId: job.tallyFormId }}>
    function getResponsiveWidth() {
      const screenWidth = window.innerWidth;
      if (screenWidth <= 480) {
        return Math.min(screenWidth - 40, 400);
      } else if (screenWidth <= 768) {
        return Math.min(screenWidth - 60, 600);
      } else if (screenWidth <= 1024) {
        return 700;
      } else {
        return 800;
      }
    }

    const tallyOptions = {
      layout: 'modal',
      width: getResponsiveWidth(),
      hideTitle: false,
      overlay: true,
      autoClose: 3000,
      onOpen: () => {
        document.body.style.overflow = 'hidden';
      },
      onClose: () => {
        document.body.style.overflow = '';
      }
    };

    document.getElementById('applyBtn')?.addEventListener('click', () => {
      Tally.openPopup(tallyFormId, tallyOptions);
    });

    window.addEventListener('resize', () => {
      tallyOptions.width = getResponsiveWidth();
    });
  </script>
</BaseLayout>
